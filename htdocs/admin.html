<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - TinyRisks.art</title>
  <link rel="stylesheet" href="./static/css/base.css">
  <style>
    .admin-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 2rem;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--accent);
    }
    
    .logout-btn {
      padding: 0.5rem 1.5rem;
      background: var(--ink);
      color: var(--bg);
      border: none;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 0.85rem;
    }
    
    .logout-btn:hover {
      opacity: 0.8;
    }
    
    .upload-section {
      background: var(--surface);
      padding: 2rem;
      border: 2px solid var(--accent);
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    
    .upload-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .form-group label {
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.85rem;
    }
    
    .form-group input[type="file"] {
      padding: 0.75rem;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--ink);
      border-radius: 4px;
    }
    
    .form-group textarea {
      padding: 0.75rem;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--ink);
      font-size: 1rem;
      border-radius: 4px;
      min-height: 120px;
      font-family: inherit;
      resize: vertical;
    }
    
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .char-count {
      font-size: 0.85rem;
      color: var(--ink);
      opacity: 0.7;
      text-align: right;
    }
    
    .char-count.warning {
      color: #e74c3c;
      opacity: 1;
    }
    
    .upload-btn {
      padding: 1rem;
      background: var(--accent);
      color: var(--bg);
      border: none;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .upload-btn:hover {
      opacity: 0.9;
    }
    
    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status-message {
      font-size: 0.9rem;
      text-align: center;
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
    }
    
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body data-theme="brass">

  <header>
    <div style="display:flex;align-items:center;gap:14px">
      <div class="mark"></div>
      <div>
        <a href="/" style="text-decoration:none;color:inherit">
          <div class="brand" style="font-weight:bold;font-size:1.5rem">TinyRisks</div>
        </a>
        <div style="font-weight:600;color:var(--ink);font-size:.9rem">Art Studio</div>
      </div>
    </div>
    <nav style="font-size:1.3rem;font-weight:bold;text-align:center">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/gallery">Gallery</a></li>
        <li><a href="/writing">Writing</a></li>
        <li><a href="/admin" class="active">Admin</a></li>
      </ul>
    </nav>
  </header>

  <div class="admin-container">
    <div class="admin-header">
      <h1 style="margin: 0; color: var(--accent);">Admin Dashboard</h1>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <!-- Community Gallery Management Section -->
    <div class="upload-section">
      <h2 style="color: var(--accent); margin-top: 0;">Community Gallery Management</h2>
      
      <form id="communityForm" class="upload-form">
        <input type="hidden" id="editingId" value="">
        
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required placeholder="Enter gallery title" style="padding: 0.75rem; border: 1px solid var(--line); background: var(--bg); color: var(--ink); border-radius: 4px; font-size: 1rem;">
        </div>
        
        <div class="form-group">
          <label for="caption">Caption</label>
          <input type="text" id="caption" name="caption" placeholder="Short caption (optional)" style="padding: 0.75rem; border: 1px solid var(--line); background: var(--bg); color: var(--ink); border-radius: 4px; font-size: 1rem;">
        </div>
        
        <div class="form-group">
          <label for="communityDescription">Description</label>
          <textarea id="communityDescription" name="description" placeholder="Detailed description (optional)" style="padding: 0.75rem; border: 1px solid var(--line); background: var(--bg); color: var(--ink); font-size: 1rem; border-radius: 4px; min-height: 100px; font-family: inherit; resize: vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label for="images">Images (Min: 1, Max: 9, Max size: 20MB each) *</label>
          <input type="file" id="images" name="images" accept="image/*" multiple required style="padding: 0.75rem; border: 1px solid var(--line); background: var(--bg); color: var(--ink); border-radius: 4px;">
          <div style="font-size: 0.85rem; color: var(--muted); margin-top: 0.5rem;">
            Selected: <span id="fileCount">0</span> file(s)
          </div>
        </div>
        
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="upload-btn" id="saveBtn" style="flex: 1;">Save Gallery Item</button>
          <button type="button" class="upload-btn" id="cancelBtn" style="flex: 0; background: var(--line); display: none;">Cancel</button>
        </div>
        
        <div id="communityStatus" style="display: none;" role="alert" aria-live="polite"></div>
      </form>
    </div>

    <!-- Gallery Items List -->
    <div class="upload-section">
      <h2 style="color: var(--accent); margin-top: 0;">Gallery Items</h2>
      <div id="galleryItems" style="display: flex; flex-direction: column; gap: 1rem;">
        <p style="color: var(--muted); text-align: center;">Loading...</p>
      </div>
    </div>

    <div style="text-align: center; margin-top: 2rem;">
      <a href="/" style="color: var(--accent); text-decoration: none;">← Back to Site</a>
    </div>
  </div>

  <footer>
    <p>© <span id="year"></span> TinyRisks.art — Built with semantic HTML + simple CSS.</p>
  </footer>

  <script src="./static/js/components.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Logout functionality
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        if (data.success) {
          window.location.href = data.redirect;
        }
      } catch (err) {
        console.error('Logout failed', err);
      }
    });

    // Community Gallery Management
    const communityForm = document.getElementById('communityForm');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const communityStatus = document.getElementById('communityStatus');
    const editingId = document.getElementById('editingId');
    const imagesInput = document.getElementById('images');
    const fileCount = document.getElementById('fileCount');

    // File count update
    imagesInput.addEventListener('change', () => {
      const count = imagesInput.files.length;
      fileCount.textContent = count;
      
      if (count > 9) {
        showStatus('Maximum 9 images allowed', 'error');
        // Clear invalid selection and reset count to prevent submitting too many files
        imagesInput.value = '';
        fileCount.textContent = '0';
      }
    });

    // Load gallery items
    async function loadGalleryItems() {
      try {
        const response = await fetch('/api/community-images');
        const items = await response.json();
        
        const container = document.getElementById('galleryItems');
        
        if (items.length === 0) {
          container.innerHTML = '<p style="color: var(--muted); text-align: center;">No gallery items yet. Create your first one!</p>';
          return;
        }
        
        container.innerHTML = items.map(item => `
          <div style="border: 2px solid var(--line); padding: 1.5rem; border-radius: 8px; background: var(--bg);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; color: var(--accent);">${escapeHtml(item.title)}</h3>
                ${item.caption ? `<p style="margin: 0 0 0.5rem 0; color: var(--ink); font-style: italic;">${escapeHtml(item.caption)}</p>` : ''}
                ${item.description ? `<p style="margin: 0; color: var(--muted); font-size: 0.9rem;">${escapeHtml(item.description)}</p>` : ''}
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="editItem(${item.id})" style="padding: 0.5rem 1rem; background: var(--accent); color: var(--bg); border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Edit</button>
                <button onclick="deleteItem(${item.id})" style="padding: 0.5rem 1rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Delete</button>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
              ${item.images.map(img => `
                <img src="/static/uploads/${escapeHtml(img)}" alt="" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px;">
              `).join('')}
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--muted);">
              ${item.images.length} image(s) • Created: ${new Date(item.created_at).toLocaleDateString()}
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Failed to load gallery items', err);
        document.getElementById('galleryItems').innerHTML = '<p style="color: #e74c3c; text-align: center;">Failed to load gallery items</p>';
      }
    }

    // Edit item
    window.editItem = async function(id) {
      try {
        const response = await fetch(`/api/community-images/${id}`);
        const item = await response.json();
        
        document.getElementById('title').value = item.title;
        document.getElementById('caption').value = item.caption || '';
        document.getElementById('communityDescription').value = item.description || '';
        editingId.value = id;
        
        // Make images optional for editing
        imagesInput.required = false;
        
        saveBtn.textContent = 'Update Gallery Item';
        cancelBtn.style.display = 'block';
        
        // Scroll to form
        communityForm.scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        showStatus('Failed to load item for editing', 'error');
      }
    };

    // Cancel editing
    cancelBtn.addEventListener('click', () => {
      communityForm.reset();
      editingId.value = '';
      imagesInput.required = true;
      saveBtn.textContent = 'Save Gallery Item';
      cancelBtn.style.display = 'none';
      fileCount.textContent = '0';
      communityStatus.style.display = 'none';
    });

    // Delete item
    window.deleteItem = async function(id) {
      if (!confirm('Are you sure you want to delete this gallery item? This will also delete all associated images.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/community-images/${id}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showStatus('Gallery item deleted successfully', 'success');
          loadGalleryItems();
        } else {
          throw new Error(data.error || 'Delete failed');
        }
      } catch (err) {
        showStatus(err.message, 'error');
      }
    };

    // Form submission
    communityForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(communityForm);
      const isEditing = editingId.value !== '';
      
      // Validate file count for new items
      if (!isEditing) {
        const files = imagesInput.files;
        if (files.length === 0) {
          showStatus('At least one image is required', 'error');
          return;
        }
        if (files.length > 9) {
          showStatus('Maximum 9 images allowed', 'error');
          return;
        }
        
        // Validate file sizes
        for (let i = 0; i < files.length; i++) {
          if (files[i].size > 20 * 1024 * 1024) {
            showStatus(`File "${files[i].name}" exceeds 20MB limit`, 'error');
            return;
          }
        }
      }
      
      const originalText = saveBtn.textContent;
      saveBtn.textContent = isEditing ? 'Updating...' : 'Saving...';
      saveBtn.disabled = true;
      communityStatus.style.display = 'none';

      try {
        const url = isEditing ? `/api/community-images/${editingId.value}` : '/api/community-images';
        const method = isEditing ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showStatus(`Gallery item ${isEditing ? 'updated' : 'created'} successfully!`, 'success');
          communityForm.reset();
          editingId.value = '';
          imagesInput.required = true;
          saveBtn.textContent = 'Save Gallery Item';
          cancelBtn.style.display = 'none';
          fileCount.textContent = '0';
          loadGalleryItems();
        } else {
          throw new Error(data.error || `${isEditing ? 'Update' : 'Create'} failed`);
        }
      } catch (err) {
        showStatus(err.message, 'error');
      } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    });

    function showStatus(message, type) {
      communityStatus.textContent = message;
      communityStatus.className = `status-message ${type}`;
      communityStatus.style.display = 'block';
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          communityStatus.style.display = 'none';
        }, 5000);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initial load
    loadGalleryItems();
  </script>
</body>
</html>
